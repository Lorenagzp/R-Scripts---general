# -*- coding: utf-8 -*-
# ---------------------------------------------------------------------------
# joinZonalStats_hyper_BW_pruebas.py
# Created on: 2014-06-07 11:06:16.00000
#   (generated by ArcGIS/ModelBuilder)
# Usage: joinZonalStats_hyper_BW_pruebas <Buffer> <Stats_table> <Grid> <Zone_field_and_join_Field> <Field_Name_Calculate_field> <Expression_Calculate_field> <Expression> <band> <Raster_set> 
# Description: 
# ---------------------------------------------------------------------------

# Import arcpy module
import os
import arcpy

try:
    # Check out any necessary licenses
    arcpy.CheckOutExtension("spatial")

    #workspace

    bwPath = "D:\\AB2013-2014\\PA"
    bwVectoresPath = bwPath + "\\" + "vectoriales"
    bwDataPath = bwPath + "\\" + "data"
    bwGdbPath = bwVectoresPath + "\\" + "EM38.gdb"
    tempGdb = "C:\\vuelos\\temp.gdb"
    arcpy.env.workspace = bwPath

    #List of band names
    #bandNames = ["392.03027","393.87228","395.71426","397.55627","399.39830","401.24026","403.08228","404.92430","406.76627","408.60828","410.45030","412.29227","414.13428","415.97630","417.81827","419.66028","421.50230","423.34427","425.18628","427.02830","428.87027","430.71228","432.55430","434.39627","436.23828","438.08030","439.92227","441.76428","443.60630","445.44827","447.29028","449.13230","450.97427","452.81628","454.65826","456.50027","458.34230","460.18427","462.02628","463.86830","465.71027","467.55228","469.39430","471.23627","473.07828","474.92030","476.76227","478.60428","480.44630","482.28827","484.13028","485.97230","487.81427","489.65628","491.49830","493.34027","495.18228","497.02430","498.86627","500.70828","502.55030","504.39227","506.23428","508.07626","509.91827","511.76028","513.60230","515.44430","517.28625","519.12830","520.97030","522.81226","524.65430","526.49630","528.33826","530.18030","532.02230","533.86426","535.70630","537.54830","539.39026","541.23230","543.07430","544.91626","546.75830","548.60030","550.44226","552.28430","554.12630","555.96826","557.81030","559.65230","561.49426","563.33630","565.17830","567.02026","568.86230","570.70430","572.54626","574.38830","576.23030","578.07227","579.91430","581.75630","583.59827","585.44030","587.28230","589.12427","590.96630","592.80830","594.65027","596.49225","598.33430","600.17630","602.01825","603.86030","605.70230","607.54425","609.38630","611.22830","613.07025","614.91230","616.75430","618.59625","620.43830","622.28030","624.12225","625.96430","627.80630","629.64825","631.49030","633.33230","635.17426","637.01630","638.85830","640.70026","642.54230","644.38430","646.22626","648.06830","649.91030","651.75226","653.59430","655.43630","657.27826","659.12030","660.96230","662.80426","664.64630","666.48830","668.33026","670.17230","672.01430","673.85626","675.69830","677.54030","679.38226","681.22430","683.06630","684.90826","686.75030","688.59230","690.43427","692.27630","694.11830","695.96027","697.80230","699.64430","701.48627","703.32830","705.17030","707.01227","708.85430","710.69630","712.53827","714.38025","716.22230","718.06430","719.90625","721.74830","723.59030","725.43225","727.27430","729.11630","730.95825","732.80030","734.64230","736.48425","738.32630","740.16830","742.01025","743.85230","745.69430","747.53625","749.37830","751.22030","753.06226","754.90430","756.74630","758.58826","760.43030","762.27230","764.11426","765.95630","767.79830","769.64026","771.48230","773.32430","775.16626","777.00830","778.85030","780.69226","782.53430","784.37630","786.21826","788.06030","789.90230","791.74426","793.58630","795.42830","797.27026","799.11230","800.95430","802.79626","804.63830","806.48030","808.32227","810.16430","812.00630","813.84827","815.69030","817.53230","819.37427","821.21630","823.05830","824.90027","826.74225","828.58430","830.42630","832.26825","834.11030","835.95230","837.79425","839.63630","841.47830","843.32025","845.16230","847.00430","848.84625","850.68830"]
    #Short list of band names for test
    #bandNames = ["392.03027","393.87228"] #Testing purpose
    bandNames = [
    "Resampled Band 1 (H140507_PA_1m.dat) (397.556274 Nanometers)",
    "Resampled Band 2 (H140507_PA_1m.dat) (404.924286 Nanometers)",
    "Resampled Band 3 (H140507_PA_1m.dat) (412.292267 Nanometers)",
    "Resampled Band 4 (H140507_PA_1m.dat) (419.660278 Nanometers)",
    "Resampled Band 5 (H140507_PA_1m.dat) (427.028290 Nanometers)",
    "Resampled Band 6 (H140507_PA_1m.dat) (434.396271 Nanometers)",
    "Resampled Band 7 (H140507_PA_1m.dat) (441.764282 Nanometers)",
    "Resampled Band 8 (H140507_PA_1m.dat) (449.132294 Nanometers)",
    "Resampled Band 9 (H140507_PA_1m.dat) (456.500275 Nanometers)",
    "Resampled Band 10 (H140507_PA_1m.dat) (463.868286 Nanometers)",
    "Resampled Band 11 (H140507_PA_1m.dat) (471.236267 Nanometers)",
    "Resampled Band 12 (H140507_PA_1m.dat) (478.604279 Nanometers)",
    "Resampled Band 13 (H140507_PA_1m.dat) (485.972290 Nanometers)",
    "Resampled Band 14 (H140507_PA_1m.dat) (493.340271 Nanometers)",
    "Resampled Band 15 (H140507_PA_1m.dat) (500.708282 Nanometers)",
    "Resampled Band 16 (H140507_PA_1m.dat) (508.076263 Nanometers)",
    "Resampled Band 17 (H140507_PA_1m.dat) (515.444275 Nanometers)",
    "Resampled Band 18 (H140507_PA_1m.dat) (522.812256 Nanometers)",
    "Resampled Band 19 (H140507_PA_1m.dat) (530.180298 Nanometers)",
    "Resampled Band 20 (H140507_PA_1m.dat) (537.548279 Nanometers)",
    "Resampled Band 21 (H140507_PA_1m.dat) (544.916260 Nanometers)",
    "Resampled Band 22 (H140507_PA_1m.dat) (552.284302 Nanometers)",
    "Resampled Band 23 (H140507_PA_1m.dat) (559.652283 Nanometers)",
    "Resampled Band 24 (H140507_PA_1m.dat) (567.020264 Nanometers)",
    "Resampled Band 25 (H140507_PA_1m.dat) (574.388306 Nanometers)",
    "Resampled Band 26 (H140507_PA_1m.dat) (581.756287 Nanometers)",
    "Resampled Band 27 (H140507_PA_1m.dat) (589.124268 Nanometers)",
    "Resampled Band 28 (H140507_PA_1m.dat) (596.492249 Nanometers)",
    "Resampled Band 29 (H140507_PA_1m.dat) (603.860291 Nanometers)",
    "Resampled Band 30 (H140507_PA_1m.dat) (611.228271 Nanometers)",
    "Resampled Band 31 (H140507_PA_1m.dat) (618.596252 Nanometers)",
    "Resampled Band 32 (H140507_PA_1m.dat) (625.964294 Nanometers)",
    "Resampled Band 33 (H140507_PA_1m.dat) (633.332275 Nanometers)",
    "Resampled Band 34 (H140507_PA_1m.dat) (640.700256 Nanometers)",
    "Resampled Band 35 (H140507_PA_1m.dat) (648.068298 Nanometers)",
    "Resampled Band 36 (H140507_PA_1m.dat) (655.436279 Nanometers)",
    "Resampled Band 37 (H140507_PA_1m.dat) (662.804260 Nanometers)",
    "Resampled Band 38 (H140507_PA_1m.dat) (670.172302 Nanometers)",
    "Resampled Band 39 (H140507_PA_1m.dat) (677.540283 Nanometers)",
    "Resampled Band 40 (H140507_PA_1m.dat) (684.908264 Nanometers)",
    "Resampled Band 41 (H140507_PA_1m.dat) (692.276306 Nanometers)",
    "Resampled Band 42 (H140507_PA_1m.dat) (699.644287 Nanometers)",
    "Resampled Band 43 (H140507_PA_1m.dat) (707.012268 Nanometers)",
    "Resampled Band 44 (H140507_PA_1m.dat) (714.380249 Nanometers)",
    "Resampled Band 45 (H140507_PA_1m.dat) (721.748291 Nanometers)",
    "Resampled Band 46 (H140507_PA_1m.dat) (729.116272 Nanometers)",
    "Resampled Band 47 (H140507_PA_1m.dat) (736.484253 Nanometers)",
    "Resampled Band 48 (H140507_PA_1m.dat) (743.852295 Nanometers)",
    "Resampled Band 49 (H140507_PA_1m.dat) (751.220276 Nanometers)",
    "Resampled Band 50 (H140507_PA_1m.dat) (758.588257 Nanometers)",
    "Resampled Band 51 (H140507_PA_1m.dat) (765.956299 Nanometers)",
    "Resampled Band 52 (H140507_PA_1m.dat) (773.324280 Nanometers)",
    "Resampled Band 53 (H140507_PA_1m.dat) (780.692261 Nanometers)",
    "Resampled Band 54 (H140507_PA_1m.dat) (788.060303 Nanometers)",
    "Resampled Band 55 (H140507_PA_1m.dat) (795.428284 Nanometers)",
    "Resampled Band 56 (H140507_PA_1m.dat) (802.796265 Nanometers)",
    "Resampled Band 57 (H140507_PA_1m.dat) (810.164307 Nanometers)",
    "Resampled Band 58 (H140507_PA_1m.dat) (817.532288 Nanometers)",
    "Resampled Band 59 (H140507_PA_1m.dat) (824.900269 Nanometers)",
    "Resampled Band 60 (H140507_PA_1m.dat) (832.268250 Nanometers)",
    "Resampled Band 61 (H140507_PA_1m.dat) (839.636292 Nanometers)",
    "Resampled Band 62 (H140507_PA_1m.dat) (847.004272 Nanometers)"]


    # Load required toolboxes
    print "Start!"
    #Type: Feature layer
    bf_Lx_1 = arcpy.GetParameterAsText(0)
    L_merge = bf_Lx_1
    arcpy.AddMessage("read b1 " + bf_Lx_1)
    print bf_Lx_1

    #type: Feature layer
    Grid = arcpy.GetParameterAsText(1)
    #gridName = "H140117_BW"
    #Grid = bwGdbPath + "\\" + gridName 
    arcpy.AddMessage("read " + Grid)
    desc = arcpy.Describe(Grid)
    gPath = desc.path
    gridSource = str(gPath) + "\\" + Grid
    arcpy.AddMessage("Grid source: " + gridSource)
    gridName = desc.baseName
    arcpy.AddMessage("Grid basename: " + gridName)
    
    print Grid

    #type: Raster layer
    Raster = arcpy.GetParameterAsText(2)
    #Raster = "E:\\140117\\140117H\\ortho\\140117_3_810.bsq" # provide a default value if unspecified
    #Raster = "c:\\vuelos\\140117_3_810.bsq"
    arcpy.AddMessage("read " + Raster)
    desc = arcpy.Describe(Raster)
    rPath = desc.path
    Raster = str(rPath) + "\\" + desc.baseName+ "." +desc.extension
    arcpy.AddMessage("Raster source: " + Raster)
    print Raster

    #Folder to store the tables with the bands  
    #type: Geodatabase
    #tablesPath = arcpy.GetParameterAsText(5) 
    tablesPath = tempGdb
    print tablesPath
        
    # Local variables:
    arcpy.AddMessage("Local variables")
    print "Local variables"
    Zone_field_and_join_Field = "PointID"
    gridLayer = "gridLayer"
    

    ## Make a layer
    print "Make layer"
    arcpy.MakeFeatureLayer_management(Grid, "gridLayer")

    i=1
    for b in bandNames:
        arcpy.AddMessage("b: " + b)
        band = Raster + "\\" + b
        arcpy.AddMessage("band: " + band)
        bandField = "B" + str(i)
        print bandField
        #Set table name
        tableName = gridName + "_" + str(i) + "_" + bandField #+ ".dbf"
        L_Stats_table = tablesPath + "\\" + tableName
        print L_Stats_table
        Field_Name_Calculate_field = gridName + "." + bandField
        print Field_Name_Calculate_field
        Expression_Select_layer = tableName+".Mean IS NOT NULL"
        # Use this if the stats were saved to a dbf file "\""+tableName+".Mean\" IS NOT NULL"
        # Use this if the stats were saved to a table "\""+tableName+":Mean\" IS NOT NULL"
        # Use this if the stats were saved to a database table tableName+".Mean IS NOT NULL"
        print Expression_Select_layer
        Expression_Calculate_field = "round(!"+tableName+".Mean!,0)"
        #the "!"+tableName+":Mean!" notation (:)is used when the stats are saved to a table
        #the "!"+tableName+".Mean!" notation (.)is used when the stats are saved to a dbf file
        print Expression_Calculate_field
        
        

        # Process: Zonal Statistics as Table
        print "Zonal statistics..."
        zs = arcpy.gp.ZonalStatisticsAsTable_sa(L_merge, Zone_field_and_join_Field, band, L_Stats_table, "DATA", "MEAN")
        arcpy.AddMessage("stats table: " + str(zs))
        
        
        # Process: Add Join
        print "Joining..."
        arcpy.AddMessage("grid..."+ gridLayer)
        arcpy.AddMessage("field..."+Zone_field_and_join_Field)
        arcpy.AddJoin_management(gridLayer, Zone_field_and_join_Field, zs, Zone_field_and_join_Field, "KEEP_ALL")    

        # Process: Select Layer By Attribute
        if i==1:
            print "Selecting Layer..."
            gridLayerSelection = arcpy.SelectLayerByAttribute_management(gridLayer, "NEW_SELECTION", Expression_Select_layer)

        # Process: Calculate Field
        print "Calculating field"
        arcpy.AddMessage("Calculating field...")
        arcpy.CalculateField_management(gridLayerSelection, Field_Name_Calculate_field, Expression_Calculate_field, "PYTHON")

        # Process: Remove Join
        arcpy.AddMessage("remove Join")
        arcpy.RemoveJoin_management(gridLayer, "")
        #Erase stats table
        arcpy.Delete_management(zs)        
        i+=1
              
    #Erase merge file
    arcpy.AddMessage("delete merge temp")
    arcpy.Delete_management(L_merge)
    print "Finish"

except Exception, e:
    # If an error occurred, print line number and error message
    import traceback, sys
    tb = sys.exc_info()[2]
    arcpy.AddMessage("Line:" + str(tb.tb_lineno))
    print "Line %i" % tb.tb_lineno
    arcpy.AddMessage("Error " + e.message)
    print e.message
    print "OMG!"
  

